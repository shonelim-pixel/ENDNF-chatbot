<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>END NF 학교폭력 상담 챗봇</title>
<meta name="description" content="학교폭력 법률상담과 심리상담을 제공하는 AI 챗봇입니다.">
<meta property="og:title" content="END NF 학교폭력 상담 챗봇">
<meta property="og:description" content="학교폭력으로 힘드신가요? 법률상담과 심리상담을 무료로 받아보세요.">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&display=swap" rel="stylesheet">
<style>
:root{--pri:#E8725A;--pri-l:#FF8C6B;--pri-s:#FFB088;--bg:#FFF8F3;--bot-bg:#FFF0E6;--usr-bg:#FF8C6B;--txt:#3D2B1F;--txt2:#7A6055;--txt3:#A89080;--bdr:#F0DDD0;--shd:rgba(232,114,90,.1);--r:16px;--rs:12px}
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'Noto Sans KR',-apple-system,BlinkMacSystemFont,sans-serif;background:var(--bg);color:var(--txt);height:100dvh;display:flex;flex-direction:column;overflow:hidden}

.hdr{background:linear-gradient(135deg,var(--pri),var(--pri-l));color:#fff;padding:14px 20px;display:flex;align-items:center;gap:12px;box-shadow:0 2px 12px var(--shd);z-index:10;flex-shrink:0}
.hdr-logo{width:42px;height:42px;background:rgba(255,255,255,.25);border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:20px;flex-shrink:0}
.hdr-info h1{font-size:15px;font-weight:700;letter-spacing:-.3px}
.hdr-info p{font-size:11px;opacity:.85;margin-top:1px}
.hdr-r{margin-left:auto;display:flex;gap:6px}
.hdr-b{background:rgba(255,255,255,.2);border:none;color:#fff;width:34px;height:34px;border-radius:50%;cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:14px;transition:.2s}
.hdr-b:hover{background:rgba(255,255,255,.35)}
.mode-pill{font-size:10px;background:rgba(255,255,255,.25);padding:2px 8px;border-radius:10px;cursor:pointer}

.chat{flex:1;overflow-y:auto;padding:16px;display:flex;flex-direction:column;gap:6px;scroll-behavior:smooth;-webkit-overflow-scrolling:touch}
.chat::-webkit-scrollbar{width:4px}
.chat::-webkit-scrollbar-thumb{background:var(--bdr);border-radius:4px}

.row{display:flex;gap:8px;max-width:85%;animation:mi .3s ease-out}
.row.u{align-self:flex-end;flex-direction:row-reverse}
.row.b{align-self:flex-start}
@keyframes mi{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:translateY(0)}}

.av{width:32px;height:32px;background:linear-gradient(135deg,var(--pri),var(--pri-l));border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:14px;flex-shrink:0;margin-top:2px}
.bbl{padding:11px 15px;border-radius:var(--r);line-height:1.7;font-size:13.5px;word-break:keep-all;overflow-wrap:break-word}
.b .bbl{background:var(--bot-bg);border-bottom-left-radius:4px}
.u .bbl{background:var(--usr-bg);color:#fff;border-bottom-right-radius:4px}
.bbl b,.bbl strong{color:var(--pri);font-weight:600}
.u .bbl b,.u .bbl strong{color:#FFE0C8}
.bbl .law{font-size:11px;color:var(--txt3);margin-top:6px;padding-top:6px;border-top:1px solid var(--bdr)}
.bbl .urg{background:#FFF0F0;border-left:3px solid #E85A5A;padding:10px 12px;border-radius:8px;margin:8px 0;font-size:13px}
.bbl .tip{background:#F0F7FF;border-left:3px solid #5A8AE8;padding:10px 12px;border-radius:8px;margin:8px 0;font-size:13px}
.ts{font-size:10px;color:var(--txt3);align-self:flex-end;flex-shrink:0}

.typ{display:none;align-self:flex-start;padding:12px 16px;background:var(--bot-bg);border-radius:var(--r);border-bottom-left-radius:4px;margin-left:40px}
.typ.on{display:flex;gap:4px;align-items:center}
.dot{width:7px;height:7px;background:var(--pri-s);border-radius:50%;animation:tb 1.4s infinite}
.dot:nth-child(2){animation-delay:.2s}
.dot:nth-child(3){animation-delay:.4s}
@keyframes tb{0%,60%,100%{transform:translateY(0)}30%{transform:translateY(-6px)}}

.qr{display:flex;flex-wrap:wrap;gap:5px;padding:4px 0;margin-left:40px;animation:mi .3s ease-out}
.qb{background:#fff;border:1.5px solid var(--pri-s);color:var(--pri);padding:7px 13px;border-radius:20px;font-size:12.5px;font-family:inherit;cursor:pointer;transition:.2s;white-space:nowrap}
.qb:hover,.qb:active{background:var(--pri);color:#fff;border-color:var(--pri)}

.inp{padding:10px 14px;background:#fff;border-top:1px solid var(--bdr);display:flex;gap:8px;align-items:flex-end;flex-shrink:0}
.inp-w{flex:1;background:var(--bg);border:1.5px solid var(--bdr);border-radius:24px;display:flex;align-items:flex-end;padding:4px 4px 4px 14px;transition:.2s}
.inp-w:focus-within{border-color:var(--pri-s)}
#ui{flex:1;border:none;background:transparent;font-size:13.5px;font-family:inherit;color:var(--txt);resize:none;max-height:100px;padding:7px 0;outline:none;line-height:1.4}
#ui::placeholder{color:var(--txt3)}
.snd{background:var(--pri);border:none;color:#fff;width:36px;height:36px;border-radius:50%;cursor:pointer;display:flex;align-items:center;justify-content:center;flex-shrink:0;transition:.2s;font-size:16px}
.snd:hover{background:var(--pri-l);transform:scale(1.05)}
.snd:disabled{opacity:.4;cursor:not-allowed;transform:none}

.ft{padding:5px 14px;background:var(--bg);text-align:center;font-size:10px;color:var(--txt3);flex-shrink:0;border-top:1px solid var(--bdr)}

/* Modal */
.mo{display:none;position:fixed;inset:0;background:rgba(0,0,0,.4);z-index:100;align-items:center;justify-content:center;padding:20px}
.mo.on{display:flex}
.mc{background:#fff;border-radius:var(--r);max-width:420px;width:100%;max-height:80vh;overflow-y:auto;box-shadow:0 20px 60px rgba(0,0,0,.15)}
.mh{padding:16px 20px;border-bottom:1px solid var(--bdr);display:flex;align-items:center;justify-content:space-between}
.mh h2{font-size:15px;font-weight:700}
.mx{background:none;border:none;font-size:22px;cursor:pointer;color:var(--txt3);padding:4px}
.mb{padding:20px}
.mb label{display:block;font-size:12px;font-weight:600;color:var(--txt2);margin-bottom:5px}
.mb input,.mb select{width:100%;padding:9px 12px;border:1.5px solid var(--bdr);border-radius:var(--rs);font-size:13px;font-family:inherit;outline:none;margin-bottom:14px;transition:.2s}
.mb input:focus,.mb select:focus{border-color:var(--pri-s)}
.mb .ht{font-size:10.5px;color:var(--txt3);margin-top:-10px;margin-bottom:14px}
.sv{background:var(--pri);color:#fff;border:none;padding:11px 20px;border-radius:var(--rs);font-size:13px;font-family:inherit;font-weight:500;cursor:pointer;width:100%;transition:.2s}
.sv:hover{background:var(--pri-l)}
.badge{display:inline-flex;align-items:center;gap:5px;padding:3px 10px;border-radius:12px;font-size:11px;font-weight:500;margin-bottom:14px}
.badge.g{background:#E8F5E9;color:#2E7D32}
.badge.o{background:#FFF3E0;color:#E65100}
.bdot{width:6px;height:6px;border-radius:50%}
.g .bdot{background:#4CAF50}
.o .bdot{background:#FF9800}

/* Welcome */
.wel{display:flex;flex-direction:column;align-items:center;justify-content:center;padding:24px;text-align:center}
.wel-i{width:72px;height:72px;background:linear-gradient(135deg,var(--pri),var(--pri-l));border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:34px;margin-bottom:14px;box-shadow:0 8px 24px var(--shd)}
.wel h2{font-size:18px;font-weight:700;margin-bottom:6px}
.wel p{font-size:12.5px;color:var(--txt2);line-height:1.6;max-width:300px;margin-bottom:16px}
.tg{display:grid;grid-template-columns:1fr 1fr;gap:7px;width:100%;max-width:340px}
.tc{background:#fff;border:1.5px solid var(--bdr);border-radius:var(--rs);padding:12px 10px;text-align:center;cursor:pointer;transition:.2s;font-family:inherit}
.tc:hover,.tc:active{border-color:var(--pri-s);background:var(--bot-bg);transform:translateY(-1px)}
.tc-i{font-size:22px;margin-bottom:4px}
.tc-l{font-size:12px;font-weight:500}

@media(max-width:400px){.hdr{padding:10px 12px}.chat{padding:10px}.tg{gap:5px}.tc{padding:10px 8px}}
</style>
</head>
<body>

<div class="hdr">
  <div class="hdr-logo">🛡️</div>
  <div class="hdr-info">
    <h1>END NF 학교폭력 상담 챗봇</h1>
    <p>법률상담 · 심리상담 · 24시간 함께합니다</p>
  </div>
  <div class="hdr-r">
    <span class="mode-pill" id="modePill" onclick="openModal()">🤖 AI</span>
    <button class="hdr-b" onclick="openModal()" title="설정">⚙</button>
  </div>
</div>

<div class="chat" id="chat">
  <div class="wel" id="wel">
    <div class="wel-i">🛡️</div>
    <h2>안녕하세요, 여기는 안전한 공간이에요</h2>
    <p>학교폭력 관련 법률·심리 상담을 도와드립니다.<br>어떤 이야기든 편하게 말씀해 주세요.</p>
    <div class="tg">
      <button class="tc" onclick="ask('학교폭력이 뭔지 알고 싶어요')"><div class="tc-i">📖</div><div class="tc-l">학교폭력이란?</div></button>
      <button class="tc" onclick="ask('학교폭력을 당하고 있어요')"><div class="tc-i">🆘</div><div class="tc-l">신고·대처방법</div></button>
      <button class="tc" onclick="ask('피해학생은 어떤 보호를 받나요?')"><div class="tc-i">🤝</div><div class="tc-l">피해학생 지원</div></button>
      <button class="tc" onclick="ask('가해학생에게는 어떤 조치가 있나요?')"><div class="tc-i">⚖️</div><div class="tc-l">가해학생 조치</div></button>
      <button class="tc" onclick="ask('너무 힘들고 무서워요')"><div class="tc-i">💛</div><div class="tc-l">심리상담</div></button>
      <button class="tc" onclick="ask('사이버폭력을 당하고 있어요')"><div class="tc-i">📱</div><div class="tc-l">사이버폭력</div></button>
    </div>
  </div>
  <div class="typ" id="typ"><div class="dot"></div><div class="dot"></div><div class="dot"></div></div>
</div>

<div class="inp">
  <div class="inp-w">
    <textarea id="ui" rows="1" placeholder="궁금한 점을 물어보세요..." onkeydown="kd(event)" oninput="ar(this)"></textarea>
  </div>
  <button class="snd" id="sb" onclick="send()">
    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg>
  </button>
</div>
<div class="ft">⚠️ 참고용 정보이며, 정확한 법률 자문은 전문가와 상담하세요 ｜ 긴급 시 117</div>

<!-- Settings Modal -->
<div class="mo" id="modal">
  <div class="mc">
    <div class="mh"><h2>⚙️ 챗봇 설정</h2><button class="mx" onclick="closeModal()">×</button></div>
    <div class="mb">
      <div id="stBadge"></div>
      <label>응답 모드</label>
      <select id="modeSelect" onchange="toggleAI()">
        <option value="ai">🤖 AI 모드 — Gemini + Google 검색 (추천)</option>
        <option value="smart">🧠 스마트 모드 (오프라인, API 불필요)</option>
      </select>
      <div id="aiFields">
        <label>Gemini API 키</label>
        <input type="password" id="keyInput" placeholder="AIzaSy...">
        <p class="ht">Google AI Studio에서 발급받은 키를 입력하면 됩니다. 현재 키가 내장되어 있어 바로 사용 가능합니다.</p>
        <label style="margin-top:4px">🌐 Google 검색 연동</label>
        <select id="searchToggle">
          <option value="on">활성화 — 최신 정보 자동 검색 (추천)</option>
          <option value="off">비활성화 — 내장 지식만 사용</option>
        </select>
      </div>
      <button class="sv" onclick="saveCfg()">저장</button>
    </div>
  </div>
</div>

<script>
// ============================================================
// END NF 학교폭력 상담 챗봇 v2 — Smart + AI Mode
// ============================================================

const GEMINI_KEY = 'AIzaSyBG1lFgAYGztwCpTbkTVLfGga0jRcmfAns';
const CFG = {
  mode: localStorage.getItem('enf_m') || 'ai',
  key: localStorage.getItem('enf_k') || GEMINI_KEY,
  search: localStorage.getItem('enf_s') || 'on'
};
let hist = [], busy = false;

// ===================== KNOWLEDGE CHUNKS =====================
// 지식을 작은 단위로 분리하여 질문에 맞는 핵심만 골라 답변
const K = [
// --- 정의 ---
{id:'d1',c:'정의',t:['학교폭력','뭐','무엇','정의','뭔지','종류','유형','어떤것'],
 q:'학교폭력이란 무엇인가요?',
 a:'학교폭력이란 학교 안팎에서 학생을 대상으로 발생하는 신체적·정서적 피해를 주는 행위를 말해요. 때리거나 밀치는 신체폭력, 욕설·모욕 같은 언어폭력, 집단따돌림, 사이버폭력, 금품갈취, 강요, 성폭력, 재물손괴가 모두 포함됩니다.',
 law:'학교폭력예방법 제2조'},
{id:'d2',c:'정의',t:['등하교','학원','밖','범위','어디','온라인'],
 q:'학교 밖에서 일어나도 학교폭력인가요?',
 a:'네, 등하교길·학원·온라인에서 발생한 일도 학교폭력에 해당해요. 학교 안에서만이 아니라 학생 간에 벌어지는 폭력이면 장소와 관계없이 법의 보호를 받을 수 있습니다.',
 law:'학교폭력예방법 제2조'},

// --- 신고 ---
{id:'r1',c:'신고',t:['신고','어떻게','도움','전화','연락','어디','대처','방법','해야','당하고'],
 q:'학교폭력을 당하면 어떻게 해야 하나요?',
 a:'가장 중요한 건 혼자 참지 않는 것이에요. 바로 할 수 있는 행동들을 알려드릴게요.\n\n📞 **117** (학교폭력 신고센터, 24시간)\n📞 **112** (경찰 긴급신고)\n📞 **1388** (청소년 전화, 24시간 상담)\n\n학교에서는 담임선생님, 상담선생님, 보건선생님에게 알리면 돼요. 온라인으로는 안전Dream(117.go.kr)에서도 신고할 수 있습니다.',
 law:'학교폭력예방법 제20조'},
{id:'r2',c:'신고',t:['기록','증거','모으','녹음','스크린샷','캡처','사진','증명'],
 q:'증거는 어떻게 모으나요?',
 a:'증거 확보가 사안 처리에 큰 도움이 돼요.\n\n• **문자/채팅**: 스크린샷 저장 (날짜·시간·상대방 포함)\n• **녹음**: 본인이 대화 당사자이면 녹음 가능\n• **목격자**: 친구들의 진술 확보\n• **진단서**: 신체 피해 시 병원 진단서\n• **사건 일지**: 날짜·장소·상황을 구체적으로 기록\n\n원본은 여러 곳에 백업해 두세요.'},

// --- 절차 ---
{id:'p1',c:'절차',t:['절차','과정','처리','이후','다음','후에','조사','진행','순서'],
 q:'신고 후 어떤 절차가 진행되나요?',
 a:'신고 후 이렇게 진행돼요.\n\n**1단계** — 신고 접수 후 피해학생 즉시 보호, 피해·가해 학생 분리\n**2단계** — 사실 조사 (10일 이내)\n**3단계** — 교육지원청 학교폭력대책심의위원회에서 심의\n**4단계** — 조치 결정 → 이행 → 사후관리 (1·3·6개월)\n\n심의 전에 양측이 합의하면 학교장이 자체 해결할 수도 있어요.',
 law:'학교폭력예방법 제12조~제17조'},
{id:'p2',c:'절차',t:['심의위원회','위원회','심의','구성','누가'],
 q:'심의위원회는 어떻게 구성되나요?',
 a:'학교폭력대책심의위원회는 교육지원청에 설치되어 있어요. 교육청 관계자, 판사·검사·변호사, 의사, 학부모 대표, 경찰, 학교폭력 전문가 등으로 구성됩니다. 피해·가해 양측 모두 의견 진술 기회가 보장돼요.',
 law:'학교폭력예방법 제12조'},

// --- 피해학생 보호 ---
{id:'v1',c:'피해학생',t:['피해','보호','지원','도와','피해학생','피해자','보호조치'],
 q:'피해학생은 어떤 보호를 받을 수 있나요?',
 a:'법에 따라 이런 보호조치를 받을 수 있어요.\n\n• **1호**: 전문가 심리상담 및 조언\n• **2호**: 일시보호 (안전한 곳에서 보호)\n• **3호**: 치료 및 요양\n• **4호**: 학급교체\n• **5호**: 전학 권고\n• **6호**: 기타 보호 조치\n\n보호조치에 따른 결석은 출석으로 인정되고, 성적 불이익도 없어요.',
 law:'학교폭력예방법 제16조'},
{id:'v2',c:'피해학생',t:['치료비','병원','비용','배상','손해배상','돈'],
 q:'치료비는 누가 부담하나요?',
 a:'원칙적으로 **가해학생의 보호자가 부담**해요. 가해측이 부담하지 않으면 학교안전공제회에서 먼저 지급한 뒤 가해측에 구상할 수 있습니다.\n\n민사소송으로 치료비·위자료 등 손해배상도 청구 가능해요. 대한법률구조공단(📞 132)에서 무료 상담을 받으실 수 있습니다.',
 law:'학교폭력예방법 제16조 제6항, 민법 제750조'},
{id:'v3',c:'피해학생',t:['전학','학급교체','옮기','학교','교실'],
 q:'피해학생이 전학할 수 있나요?',
 a:'네, 심의위원회에서 피해학생 보호를 위해 학급교체(4호)나 전학(5호)을 결정할 수 있어요. 피해학생이 전학을 원하는 경우 교육장이 전학 절차를 지원합니다. 이때 가해학생은 피해학생이 전학한 학교로 전학할 수 없습니다.',
 law:'학교폭력예방법 제16조'},

// --- 가해학생 조치 ---
{id:'a1',c:'가해학생',t:['가해','처벌','조치','벌','가해학생','가해자','제재','어떻게 되'],
 q:'가해학생에게는 어떤 조치가 내려지나요?',
 a:'심의위원회 심의를 거쳐 이런 조치가 내려질 수 있어요 (경→중 순서).\n\n**1호** 서면사과 / **2호** 접촉·보복금지 / **3호** 학교봉사\n**4호** 사회봉사 / **5호** 특별교육·심리치료\n**6호** 출석정지 / **7호** 학급교체 / **8호** 전학 / **9호** 퇴학(고등학생만)\n\n폭력의 심각성·지속성·고의성, 반성 정도, 화해 여부 등을 종합적으로 고려해서 결정합니다.',
 law:'학교폭력예방법 제17조'},
{id:'a2',c:'가해학생',t:['학생부','생활기록부','기재','기록','삭제','대학','입시'],
 q:'학교생활기록부에 기재되나요?',
 a:'조치에 따라 달라요.\n\n• **1~3호 조치** → 기재 후 **졸업 시 자동 삭제**\n• **4~9호 조치** → 기재 후 **졸업 2년 뒤 삭제 심의**\n• **학교장 자체해결** → **기재하지 않음**\n\n삭제 심의에서는 조치 이행 여부, 추가 폭력 여부, 반성 정도를 봅니다.',
 law:'학교폭력예방법 제17조 제6항'},
{id:'a3',c:'가해학생',t:['불복','이의','행정심판','억울','부당','재심'],
 q:'조치에 불복하려면 어떻게 하나요?',
 a:'조치 결과에 이의가 있으면 **행정심판**을 청구할 수 있어요. 조치를 받은 날로부터 **90일 이내**에 청구해야 합니다. 행정심판은 무료이고, 법률구조공단(📞 132)이나 청소년 법률지원센터(📞 02-6003-0100)에서 도움을 받으실 수 있어요.',
 law:'학교폭력예방법 제17조의2'},

// --- 학교장 자체해결 ---
{id:'s1',c:'자체해결',t:['자체해결','학교장','합의','경미','가벼운','자체'],
 q:'학교장 자체해결은 어떤 경우에 가능한가요?',
 a:'다음 조건을 **모두** 만족해야 가능해요.\n\n• 피해학생·보호자가 심의위원회 개최를 원하지 않을 것\n• 2주 이상 치료가 필요하지 않을 것\n• 재산 피해가 없거나 즉각 복구됐을 것\n• 지속적이지 않은 사안일 것\n• 고의성이 인정되지 않을 것\n\n자체해결되면 학교생활기록부에 기재되지 않아요. 대신 관계회복 프로그램 등 교육적 조치를 병행합니다.',
 law:'학교폭력예방법 제13조의2'},

// --- 조정·화해 ---
{id:'m1',c:'조정',t:['조정','화해','분쟁','합의','관계회복','사과','용서'],
 q:'분쟁조정은 어떻게 이루어지나요?',
 a:'심의위원회가 양측 간 분쟁조정을 진행할 수 있어요.\n\n• 양측의 **동의**가 필요하고, 강제할 수 없어요\n• 신청일부터 **1개월 이내** 완료가 원칙\n• 중립 조정자가 양측 이야기를 듣고 합의점을 도출\n• 합의서 작성 후 이행을 모니터링\n\n조정이 성립되면 심의위원회가 이를 존중하여 처리합니다.',
 law:'학교폭력예방법 제18조'},

// --- 사이버폭력 ---
{id:'c1',c:'사이버폭력',t:['사이버','온라인','인터넷','카톡','카카오톡','SNS','메신저','단톡방','채팅','디지털','악플','게시글'],
 q:'사이버폭력도 학교폭력인가요?',
 a:'네, 사이버폭력도 **학교폭력에 해당**하며 법적으로 동일하게 보호받아요.\n\n종류로는 단톡방 따돌림, 온라인 명예훼손·악플, 사이버 스토킹, 성적 이미지 유포 등이 있어요.\n\n**대처 방법:**\n• 스크린샷으로 증거 확보 (날짜·시간 포함)\n• 해당 플랫폼에서 차단·신고\n• 방송통신심의위원회(📞 1377)에 게시물 삭제 요청\n• 117 또는 112에 신고',
 law:'학교폭력예방법 제2조, 정보통신망법'},

// --- 따돌림 ---
{id:'b1',c:'따돌림',t:['따돌림','왕따','외톨이','소외','무시','안놀아','끼워주지','혼자'],
 q:'따돌림도 학교폭력에 해당하나요?',
 a:'네, 따돌림은 명확한 학교폭력이에요. 두 명 이상이 특정 학생을 의도적·반복적으로 피하거나 괴롭히는 행위를 말해요.\n\n말을 걸어도 무시하기, 단톡방에서 내보내기, 밥을 같이 안 먹기 등도 모두 포함돼요.\n\n"참으면 나아진다"는 생각은 오히려 상황을 악화시킬 수 있어요. 도움을 요청하는 것은 **용기 있는 행동**입니다. 담임선생님이나 117로 알려주세요.',
 law:'학교폭력예방법 제2조'},

// --- 성폭력 ---
{id:'sx1',c:'성폭력',t:['성폭력','성희롱','성추행','성적','몰카','몰래카메라','노출','성범죄'],
 q:'학교에서 성폭력을 당했어요.',
 a:'정말 힘드셨을 거예요. 학교에서의 성폭력은 매우 심각한 학교폭력이며, 특별한 보호를 받습니다.\n\n<div class="urg"><strong>🆘 지금 바로 연락하세요</strong><br>• <b>117</b> — 학교폭력 신고<br>• <b>112</b> — 경찰 (형사사건)<br>• <b>109</b> — 여성긴급전화 (24시간)<br>• <b>해바라기센터</b> — 성폭력 원스톱 지원</div>\n\n**절대 당신 잘못이 아닙니다.** 증거를 가능한 보존하고, 빠른 시일 내 전문가에게 도움을 요청하세요.',
 law:'학교폭력예방법 제2조, 성폭력처벌법'},

// --- 금품갈취 ---
{id:'e1',c:'금품갈취',t:['금품','갈취','돈','빼앗','셔틀','심부름','빵셔틀','빌려'],
 q:'금품갈취도 학교폭력인가요?',
 a:'네, 돈이나 물건을 빼앗기거나 원치 않는 심부름을 강요받는 것도 학교폭력이에요.\n\n"빌려달라"며 안 돌려주거나, 게임 아이템·쿠폰 강제 요구, 대리 구매 강요(셔틀), 숙제를 대신 시키는 것도 포함돼요.\n\n빼앗긴 물건·금액을 기록하고, 가능하면 증거를 확보한 뒤 부모님이나 117에 신고하세요.'},

// --- 부모 ---
{id:'pr1',c:'부모',t:['부모','학부모','엄마','아빠','보호자','부모님','아이가','우리 아이','자녀'],
 q:'부모로서 어떻게 대처해야 하나요?',
 a:'자녀가 피해를 입었다면 이렇게 해주세요.\n\n**먼저 안정시키기** — "네 잘못이 아니야, 잘 말해줬어"라고 안심시켜 주세요.\n**차분하게 경청** — 캐묻기보다 기다려주시고, 감정적으로 가해학생 측에 직접 연락하지 마세요.\n**증거 확보** — 문자, 사진, 진단서 등 수집\n**신고** — 학교, 117, 교육지원청에 신고\n**전문 상담 연계** — Wee센터, 1388 등\n\n부모님의 침착하고 지지적인 태도가 자녀 회복에 가장 큰 힘이 됩니다.'},

// --- 상담 기관 ---
{id:'ct1',c:'상담기관',t:['연락처','전화번호','센터','기관','어디로','상담기관','핫라인'],
 q:'도움받을 수 있는 기관을 알려주세요.',
 a:'<div class="urg"><b>🚨 긴급</b><br>• <b>117</b> — 학교폭력 신고·상담 (24시간)<br>• <b>112</b> — 경찰 긴급신고</div>\n\n**📱 상담 전화**\n• **1388** — 청소년 전화 (24시간)\n• **1393** — 정신건강 위기상담 (24시간)\n• **1577-0199** — 정신건강복지센터\n• **109** — 여성긴급전화\n\n**🏢 방문 상담**\n• Wee센터 (학교·교육청 소속)\n• 청소년상담복지센터 (각 시·군·구)\n• 해바라기센터 (성폭력)\n\n**⚖️ 법률**\n• **132** — 법률구조공단 (무료)\n• **02-6003-0100** — 청소년 법률지원센터'},

// --- 심리: 일반 상담 ---
{id:'ps1',c:'심리',t:['상담','심리','심리상담','마음','감정','정신건강','회복','wee','위센터'],
 q:'심리상담을 받고 싶어요.',
 a:'마음의 상처를 돌보려는 결정, 정말 용기 있는 선택이에요.\n\n**무료 상담 기관을 안내해 드릴게요.**\n• **Wee센터** — 학교·교육지원청에서 전문상담 제공\n• **청소년상담복지센터** — 📞 1388 (24시간)\n• **정신건강복지센터** — 📞 1577-0199\n\n개인상담, 집단상담, 가족상담, 온라인 채팅 상담 등 다양한 방식으로 이용할 수 있어요. 상담받는 것은 부끄러운 일이 아니에요. 마음이 아프면 치료받는 것처럼 자연스러운 거예요.'},

// --- 심리: 힘듦/두려움 ---
{id:'em1',c:'감정',t:['힘들','무서','두려','겁','무섭','어떡해','고통','괴로','우울','불안','걱정','스트레스','떨려','떨리'],
 q:'너무 힘들고 무서워요.',
 a:'지금 많이 힘드시죠. 이렇게 말씀해 주셔서 감사해요. 지금 느끼는 감정은 자연스러운 반응이에요. **당신 잘못이 아닙니다.**\n\n지금 이 순간 해볼 수 있는 것들이 있어요.\n\n🫁 **깊은 호흡** — 4초 들이쉬고 → 4초 멈추고 → 6초 내쉬기 (3번 반복)\n🦶 **그라운딩** — 보이는 것 5가지, 들리는 것 4가지, 만질 수 있는 것 3가지 찾아보기\n🧊 **찬물 세수** — 긴장 완화에 도움이 돼요\n\n<div class="urg"><b>🆘 지금 바로 이야기할 수 있는 곳</b><br>• <b>1388</b> — 청소년 전화 (24시간)<br>• <b>1393</b> — 정신건강 위기상담 (24시간)<br>• 카카오톡 <b>"마음이음"</b> 검색 → 채팅 상담</div>\n\n당신은 **혼자가 아니에요.** 💛'},

// --- 심리: 위기 ---
{id:'cr1',c:'위기',t:['죽고싶','자살','자해','끝내고','사라지고','없어지고','의미없','살고싶지','죽고','목숨'],
 q:'(위기 상황)',
 a:'<div class="urg" style="background:#FFF0F0;border-left-color:#E85A5A;"><b>🆘 지금 매우 힘든 상황이시군요.</b><br><br>당신의 고통을 알겠어요. 하지만 <b>당신은 소중한 사람</b>이에요.<br>지금 바로 전문 상담사와 이야기해 주세요.<br><br><b style="font-size:15px;">📞 자살예방상담: 1393 (24시간)</b><br><b style="font-size:15px;">📞 청소년 전화: 1388 (24시간)</b><br><b style="font-size:15px;">📞 생명의 전화: 1588-9191</b><br><br>카카오톡 <b>"마음이음"</b> 검색하면 채팅 상담도 가능해요.<br><br><b>당신은 혼자가 아닙니다. 💛</b></div>'},

// --- 심리: 트라우마 ---
{id:'tr1',c:'트라우마',t:['트라우마','악몽','플래시백','떠올','기억','잊을수','ptsd','공황'],
 q:'자꾸 그 일이 떠올라요.',
 a:'사건이 계속 떠오르는 건 비정상적인 상황에 대한 **정상적인 반응**이에요.\n\n사건 후에 악몽, 갑작스러운 불안, 학교 가기 싫은 마음, 집중력 저하, 수면·식욕 변화가 나타날 수 있어요. 이런 반응은 자연스러운 거예요.\n\n**도움이 되는 방법들:**\n• 혼자 간직하지 말고 믿을 수 있는 사람에게 이야기하기\n• 규칙적인 생활 (정해진 시간에 자고, 먹기)\n• 좋아하는 음악, 산책, 일기 쓰기\n• 전문 상담 받기 (EMDR, 인지행동치료 등)\n\n트라우마는 전문가 도움을 받으면 훨씬 빠르게 회복할 수 있어요.'},

// --- 심리: 자존감 ---
{id:'se1',c:'자존감',t:['자존감','자신감','못생','바보','쓸모없','가치','존재','내 잘못','못나','나는'],
 q:'제가 부족해서 당하는 걸까요?',
 a:'절대 아니에요. **학교폭력은 당신 잘못이 아닙니다.**\n\n"내가 부족해서", "내 잘못이야"라는 생각이 드는 건 자연스럽지만, 그건 사실이 아니에요. 폭력의 책임은 100% 가해자에게 있어요.\n\n**자존감을 회복하는 작은 방법들:**\n• 매일 거울을 보며 "나는 소중한 사람이야" 말하기\n• 매일 잘한 일 3가지 적기 (아무리 작은 것도 OK)\n• 나를 존중해주는 사람과 시간 보내기\n• 좋아하는 활동으로 자기 표현하기\n\n자존감 회복은 시간이 걸려요. 조급해하지 마세요. 🌟'},

// --- 심리: 불안 ---
{id:'ax1',c:'불안',t:['불안','긴장','떨','심장','가슴','호흡','숨','패닉','손떨'],
 q:'불안하고 심장이 빨리 뛰어요.',
 a:'불안은 몸이 위험을 감지하고 보호하려는 자연스러운 반응이에요.\n\n**지금 바로 해볼 수 있는 것들:**\n\n🫁 **4-7-8 호흡법** — 4초 들이쉬기 → 7초 참기 → 8초 내쉬기 (3~5회)\n🧊 **5-4-3-2-1 그라운딩** — 보이는 것 5, 만질 수 있는 것 4, 들리는 것 3, 냄새 2, 맛 1\n🦋 **나비 토닥임** — 양팔 교차해서 어깨를 번갈아 토닥이기\n💧 **찬물** — 손목을 차가운 물에 적시기\n\n불안이 일상에 지장을 주고 있다면 Wee센터나 1388로 연락해 주세요.'},

// --- 법률상담 ---
{id:'lg1',c:'법률',t:['법률상담','변호사','법률','무료상담','법률구조','법적'],
 q:'무료 법률 상담을 받고 싶어요.',
 a:'학교폭력 관련 무료 법률 상담을 받을 수 있는 곳이 여러 군데 있어요.\n\n• **대한법률구조공단** — 📞 132 (무료 소송 대리도 가능)\n• **청소년 법률지원센터** — 📞 02-6003-0100\n• **대한변호사협회 법률구조재단** — 📞 02-3476-6001\n\n학교폭력 피해학생은 법률구조공단에서 무료로 법률 상담과 소송 대리를 받을 수 있습니다.',
 law:'법률구조법'},
];

// ===================== SMART MATCHING ENGINE =====================
function findChunks(input) {
  const q = input.toLowerCase().replace(/[?!.,\s]+/g,' ').trim();
  const words = q.split(' ').filter(w=>w.length>0);
  const scored = K.map(k => {
    let s = 0;
    for (const tag of k.t) {
      if (q.includes(tag)) s += tag.length * 2;
    }
    // partial word match
    for (const w of words) {
      for (const tag of k.t) {
        if (tag.includes(w) && w.length >= 2) s += w.length;
      }
    }
    return { ...k, score: s };
  }).filter(x => x.score > 0).sort((a,b) => b.score - a.score);
  return scored.slice(0, 3);
}

// ===================== EMOTION DETECTION =====================
function detectEmotion(input) {
  const t = input.toLowerCase();
  if (['죽고싶','자살','자해','끝내고','사라지고','없어지고','살고싶지','죽고','목숨'].some(k=>t.includes(k))) return 'crisis';
  if (['힘들','무서','두려','겁','괴로','우울','불안','걱정','떨려','떨리','무섭','고통'].some(k=>t.includes(k))) return 'distress';
  if (['감사','고마','고맙','땡큐'].some(k=>t.includes(k))) return 'thanks';
  if (['안녕','하이','hello','hi','반가'].some(k=>t.includes(k))) return 'greet';
  if (['잘가','바이','bye'].some(k=>t.includes(k))) return 'bye';
  return null;
}

// ===================== RESPONSE COMPOSER =====================
function compose(input) {
  const emo = detectEmotion(input);

  // Crisis — top priority
  if (emo === 'crisis') {
    const ck = K.find(k=>k.id==='cr1');
    return { text: ck.a, qr: ['심리상담 기관', '도움 받을 수 있는 곳'] };
  }

  // Greetings
  if (emo === 'greet') return { text: '안녕하세요! 😊 저는 **END NF 학교폭력 상담 챗봇**이에요.\n\n학교폭력 관련 법률 상담이나 심리 상담이 필요하시면 편하게 말씀해 주세요. 어떤 이야기든 비밀이 보장됩니다. 💛', qr: ['학교폭력이란?','신고 방법','심리상담 받기'] };
  if (emo === 'thanks') return { text: '도움이 되었다니 저도 기뻐요! 😊 더 궁금한 점이 있으면 언제든 물어봐 주세요.', qr: [] };
  if (emo === 'bye') return { text: '네, 좋은 하루 보내세요! 💛 필요할 때 언제든 다시 찾아와 주세요. 항상 이 자리에 있을게요.', qr: [] };

  // Find matching knowledge chunks
  const chunks = findChunks(input);

  if (chunks.length === 0) {
    return {
      text: '말씀하신 내용에 정확히 맞는 정보를 찾지 못했어요. 😅\n\n이런 주제들에 대해 도움을 드릴 수 있어요: 학교폭력 정의, 신고 방법, 피해학생 보호, 가해학생 조치, 심리상담, 사이버폭력, 법률상담 등이요.\n\n좀 더 구체적으로 여쭤봐 주시겠어요?',
      qr: ['학교폭력이란?','신고 방법','피해학생 지원','심리상담 받기','긴급 연락처']
    };
  }

  // Distress empathy prefix
  let prefix = '';
  if (emo === 'distress') {
    const empathy = ['지금 많이 힘드시죠. 먼저 말씀해 주셔서 감사해요.','정말 걱정되시죠. 당신의 마음을 알겠어요.','무서운 마음이 드실 수 있어요. 그건 자연스러운 반응이에요.'];
    prefix = empathy[Math.floor(Math.random()*empathy.length)] + '\n\n';
  }

  // Build conversational response from top chunks
  let text = prefix;
  const top = chunks[0];
  text += top.a;

  // If there's a highly relevant secondary chunk (different category), add a brief mention
  if (chunks.length > 1 && chunks[1].c !== top.c && chunks[1].score > 3) {
    text += '\n\n---\n\n💡 참고로, **' + chunks[1].q + '** 에 대해서도 알려드릴 수 있어요. 궁금하시면 물어봐 주세요!';
  }

  // Add law reference
  if (top.law) {
    text += '\n\n<div class="law">📋 근거: ' + top.law + '</div>';
  }

  // Generate quick replies from related topics
  const qr = [];
  const related = K.filter(k => k.id !== top.id && k.c !== top.c).sort(() => Math.random()-.5);
  const cats = new Set();
  for (const r of related) {
    if (cats.has(r.c)) continue;
    cats.add(r.c);
    const short = r.q.length > 20 ? r.q.substring(0,18)+'…' : r.q;
    qr.push(short);
    if (qr.length >= 4) break;
  }

  return { text, qr };
}

// ===================== MARKDOWN → HTML =====================
function md(s) {
  return s
    .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
    .replace(/\n---\n/g, '<hr style="border:none;border-top:1px solid var(--bdr);margin:6px 0">')
    .replace(/\n• /g, '\n<br>• ')
    .replace(/\n/g, '<br>');
}

// ===================== AI MODE (Gemini 2.0 Flash) =====================
const SYS_PROMPT = `당신은 "END NF 학교폭력 상담 챗봇"입니다. 학교폭력 피해학생, 학부모, 교사에게 법률·심리 상담을 적극적으로 제공합니다.

## 핵심 원칙
- 따뜻하고 공감적인 말투, 존댓말 사용
- 상대방의 감정을 먼저 인정하고 공감한 뒤, **구체적이고 실질적인 도움**을 제공
- 위기 상황(자해/자살) 시 즉시 긴급 연락처 안내
- **적극적으로 답변**: 질문에 대해 가능한 한 상세하고 실용적인 정보를 제공. 단순한 안내가 아니라 "이렇게 하세요"라는 실행 가능한 조언 위주로 답변
- Google 검색으로 가져온 최신 정보가 있다면 적극 활용하여 답변에 포함

## 법률 지식 (학교폭력예방법, 2025년)

### 정의 (제2조)
학교 내외에서 학생 대상 신체폭력, 언어폭력, 따돌림, 사이버폭력, 금품갈취, 강요, 성폭력, 재물손괴 등. 학교 밖에서 발생해도 학생 간이면 해당됨.

### 신고 (제20조)
117(24시간), 112, 1388(24시간), 학교 내 담임/상담/보건교사, 안전Dream(117.go.kr)
→ 신고 즉시 피해학생 보호조치가 시작됨. 익명신고 가능.

### 사안처리 절차
1. 신고접수 → 피해학생 즉시 보호 → 피해·가해 분리
2. 사실조사 (10일 이내, 전담기구 수행)
3. 교육지원청 심의위원회 심의 (14일 이내)
4. 조치 결정 → 이행 → 사후관리(1/3/6개월 점검)

### 피해학생 보호조치 (제16조)
1호: 심리상담, 2호: 일시보호, 3호: 치료·요양, 4호: 학급교체, 5호: 전학, 6호: 기타
결석=출석인정, 성적불이익 금지, 치료비는 가해측 부담 원칙, 즉시보호 가능

### 가해학생 조치 (제17조)
1호: 서면사과, 2호: 접촉금지, 3호: 학교봉사, 4호: 사회봉사, 5호: 특별교육/심리치료, 6호: 출석정지, 7호: 학급교체, 8호: 전학, 9호: 퇴학(고등학생만)
학생부: 1~3호 졸업시 삭제, 4~9호 졸업후 2년뒤 심의로 삭제 가능

### 학교장 자체해결 (제13조의2)
조건: 피해측 심의 불원 + 2주미만 치료 + 재산피해 없음 + 비지속 + 비고의 → 학생부 미기재

### 분쟁조정 (제18조)
양측 동의, 1개월 이내, 중립 조정자, 합의서 작성 → 법적 효력

### 행정심판·재심 (제17조의2)
가해측: 행정심판 90일 이내 청구(무료, 법률구조공단 132)
피해측: 재심청구 가능 (조치 불만 시)

## 심리 가이드
- 위기 시: 자살예방상담 1393, 청소년상담 1388, 정신건강위기 1577-0199 즉시 안내
- 트라우마: "지금 느끼는 감정은 정상적인 반응"임을 확인, 전문상담 적극 연계
- 자존감: "절대 당신 잘못이 아닙니다" 강조, 구체적 회복 방법 안내
- 불안/공포: 4-7-8 호흡법, 5-4-3-2-1 그라운딩 기법 실제로 안내
- 무료상담: Wee센터(전국), 1388(24시간), 해맑음센터, 정신건강복지센터

## 응답 규칙
1. 따뜻한 대화체로 자연스럽게, 하지만 **정보는 풍부하게** 제공
2. 관련 법 조항을 인용할 때: 📋 근거: ...
3. 단계별 실행 가이드 형태로 답변 (예: "먼저 ~하시고, 그다음 ~하세요")
4. 검색으로 얻은 최신 뉴스, 판례, 정책 변경사항이 있으면 반드시 포함
5. 답변 끝에 반드시 후속 질문 3개를 다음 형식으로: <!-- qr:["질문1","질문2","질문3"] -->
6. 200~400자 내외로 충분히 설명 (너무 짧지 않게)`;

async function callAI(msg) {
  // Build Gemini message history
  const contents = [];
  const recent = hist.slice(-16);
  for (const m of recent) {
    contents.push({
      role: m.r === 'assistant' ? 'model' : 'user',
      parts: [{ text: m.t }]
    });
  }
  contents.push({ role: 'user', parts: [{ text: msg }] });

  // Build request body
  const body = {
    contents,
    systemInstruction: { parts: [{ text: SYS_PROMPT }] },
    generationConfig: {
      temperature: 0.75,
      maxOutputTokens: 1500
    }
  };

  // Google Search grounding (if enabled)
  if (CFG.search === 'on') {
    body.tools = [{ google_search: {} }];
  }

  const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${CFG.key}`;

  const res = await fetch(url, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(body)
  });

  if (!res.ok) {
    const err = await res.json().catch(() => ({}));
    const msg = err.error?.message || `API 오류 (${res.status})`;
    throw new Error(msg);
  }

  const data = await res.json();
  const candidate = data.candidates?.[0];
  if (!candidate || !candidate.content?.parts?.length) {
    throw new Error('응답을 받지 못했습니다');
  }

  let text = candidate.content.parts.map(p => p.text || '').join('');

  // Append grounding sources if available
  const gm = candidate.groundingMetadata;
  if (gm && gm.groundingChunks && gm.groundingChunks.length > 0) {
    const sources = gm.groundingChunks
      .filter(c => c.web)
      .slice(0, 3)
      .map(c => `<a href="${c.web.uri}" target="_blank" rel="noopener">${c.web.title || '참고'}</a>`)
      .join(' · ');
    if (sources) {
      text += `\n\n🔍 **참고 자료:** ${sources}`;
    }
  }

  return text;
}

// ===================== CHAT UI =====================
function ts() { return new Date().toLocaleTimeString('ko-KR',{hour:'2-digit',minute:'2-digit'}); }

function addMsg(html, who, qr) {
  const el = document.getElementById('wel');
  if (el) el.style.display = 'none';

  const chatEl = document.getElementById('chat');
  const typEl = document.getElementById('typ');

  const row = document.createElement('div');
  row.className = `row ${who==='bot'?'b':'u'}`;
  let h = '';
  if (who==='bot') h += '<div class="av">🛡️</div>';
  h += `<div class="bbl">${html}</div><span class="ts">${ts()}</span>`;
  row.innerHTML = h;
  chatEl.insertBefore(row, typEl);

  // history
  hist.push({r: who==='bot'?'assistant':'user', t: html.replace(/<[^>]*>/g,'')});

  // quick replies
  if (qr && qr.length && who==='bot') {
    const d = document.createElement('div');
    d.className = 'qr';
    qr.forEach(q => {
      const b = document.createElement('button');
      b.className = 'qb';
      b.textContent = q;
      b.onclick = () => { d.remove(); ask(q); };
      d.appendChild(b);
    });
    chatEl.insertBefore(d, typEl);
  }
  scrollEnd();
}

function showTyp(on) { document.getElementById('typ').classList.toggle('on',on); scrollEnd(); }
function scrollEnd() { const c=document.getElementById('chat'); setTimeout(()=>c.scrollTop=c.scrollHeight,50); }
function wait(ms) { return new Promise(r=>setTimeout(r,ms)); }

async function send(custom) {
  const inp = document.getElementById('ui');
  const txt = (custom||inp.value).trim();
  if (!txt||busy) return;
  if (!custom) { inp.value=''; inp.style.height='auto'; }

  document.querySelectorAll('.qr').forEach(e=>e.remove());
  addMsg(txt.replace(/</g,'&lt;'), 'user');
  busy = true;
  document.getElementById('sb').disabled = true;
  showTyp(true);

  try {
    // Crisis always first
    if (detectEmotion(txt)==='crisis') {
      await wait(600);
      showTyp(false);
      const ck = K.find(k=>k.id==='cr1');
      addMsg(ck.a, 'bot', ['심리상담 기관','도움 받을 수 있는 곳']);
      return;
    }

    if (CFG.mode==='ai' && CFG.key) {
      // AI Mode
      try {
        const raw = await callAI(txt);
        showTyp(false);
        // extract quick replies
        let qr = ['학교폭력이란?','신고 방법','심리상담 받기'];
        const m = raw.match(/<!--\s*qr:\s*(\[.*?\])\s*-->/);
        if (m) try { qr = JSON.parse(m[1]); } catch(e){}
        const clean = raw.replace(/<!--\s*qr:.*?-->/,'');
        addMsg(md(clean), 'bot', qr);
        return;
      } catch(e) {
        console.warn('AI 실패, 스마트 모드로 전환:', e);
        showTyp(false);
        addMsg(`<div class="tip">⚠️ AI 연결에 실패하여 스마트 모드로 답변합니다. (${e.message})</div>`, 'bot');
        showTyp(true);
        await wait(400);
      }
    }

    // Smart Mode
    await wait(500 + Math.random()*400);
    showTyp(false);
    const res = compose(txt);
    addMsg(md(res.text), 'bot', res.qr);

  } finally {
    busy = false;
    document.getElementById('sb').disabled = false;
    document.getElementById('ui').focus();
  }
}

function ask(t) { send(t); }
function kd(e) { if (e.key==='Enter'&&!e.shiftKey){e.preventDefault();send();} }
function ar(el) { el.style.height='auto'; el.style.height=Math.min(el.scrollHeight,100)+'px'; }

// ===================== SETTINGS =====================
function openModal() {
  document.getElementById('modal').classList.add('on');
  document.getElementById('modeSelect').value = CFG.mode;
  document.getElementById('keyInput').value = CFG.key;
  document.getElementById('searchToggle').value = CFG.search;
  toggleAI();
  updBadge();
}
function closeModal() { document.getElementById('modal').classList.remove('on'); }
function toggleAI() { document.getElementById('aiFields').style.display = document.getElementById('modeSelect').value==='ai'?'block':'none'; }
function updBadge() {
  const el = document.getElementById('stBadge');
  if (CFG.mode==='ai'&&CFG.key) {
    const searchLabel = CFG.search==='on' ? ' + 🌐검색' : '';
    el.innerHTML=`<span class="badge g"><span class="bdot"></span>Gemini AI${searchLabel} 활성화</span>`;
  } else {
    el.innerHTML='<span class="badge o"><span class="bdot"></span>스마트 모드 (오프라인)</span>';
  }
}
function updPill() {
  const pill = document.getElementById('modePill');
  if (CFG.mode==='ai'&&CFG.key) {
    pill.textContent = CFG.search==='on' ? '🤖 AI+검색' : '🤖 AI';
  } else {
    pill.textContent = '🧠 스마트';
  }
}
function saveCfg() {
  CFG.mode = document.getElementById('modeSelect').value;
  CFG.key = document.getElementById('keyInput').value.trim() || GEMINI_KEY;
  CFG.search = document.getElementById('searchToggle').value;
  localStorage.setItem('enf_m', CFG.mode);
  localStorage.setItem('enf_k', CFG.key);
  localStorage.setItem('enf_s', CFG.search);
  updPill();
  updBadge();
  closeModal();
}
document.getElementById('modal').addEventListener('click',function(e){if(e.target===this)closeModal();});
updPill();
window.addEventListener('load', () => document.getElementById('ui').focus());
</script>
</body>
</html>
